// src/pages/GameSetup.jsx
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useGame } from "../context/GameContext";
import InputField from "../components/InputField/InputField";
import ChoosePiece from "../components/ChoosePiece";
import { useApi } from "../api/useApi";
import styles from "./GameSetup.module.css";

const GameSetup = () => {
  const [player1, setPlayer1] = useState("");
  const [player2, setPlayer2] = useState("");
  const [player1Piece, setPlayer1Piece] = useState(null);
  const [submitting, setSubmitting] = useState(false);

  const { setPlayers } = useGame();
  const { createGame, createPlayer, joinGame } = useApi();
  const navigate = useNavigate();

  const handleStartGame = async () => {
    if (!player1 || !player2) return alert("B친da spelarna m친ste ange sina namn!");
    if (!player1Piece) return alert("Spelare 1 m친ste v칛lja sin spelpj칛s!");
    if (submitting) return;

    setSubmitting(true);
    try {
      const game = await createGame(player1?.trim() || undefined);

      const p1 = await createPlayer();
      const p2 = await createPlayer();

      // Viktigt: l친t b친da spelarna g친 med i spelet
      await joinGame(game.id, p1.id);
      await joinGame(game.id, p2.id);

      const player2Piece = player1Piece === "red" ? "yellow" : "red";

      setPlayers({
        player1: { id: p1.id, name: player1, piece: player1Piece },
        player2: { id: p2.id, name: player2, piece: player2Piece },
        gameId: game.id,
      });

      navigate("/board");
    } catch (err) {
      console.error(err);
      alert(`Ett fel uppstod n칛r spelet skulle skapas/joinas:\n${err?.message || err}`);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className={styles.container}>
      <h1 className={styles.title}>Game Setup</h1>
      <div className={styles.inputGroup}>
        <InputField
          id="player1"
          label="Spelare 1"
          placeholder="Ange namn"
          value={player1}
          onChange={(e) => setPlayer1(e.target.value)}
        />
        <InputField
          id="player2"
          label="Spelare 2"
          placeholder="Ange namn"
          value={player2}
          onChange={(e) => setPlayer2(e.target.value)}
        />
      </div>

      <div>
        <h3>Spelare 1 v칛ljer sin pj칛s:</h3>
        <div className={styles.choosePieceWrapper}>
          <ChoosePiece
            value={player1Piece}
            onChange={setPlayer1Piece}
            options={[
              { id: "yellow", label: "Gul", icon: "游리" },
              { id: "red", label: "R칬d", icon: "游댮" },
            ]}
          />
        </div>
      </div>

      {player1Piece && (
        <p className={styles.selectionInfo}>
          {player1} v칛ljer: {player1Piece === "yellow" ? "游리 Gul" : "游댮 R칬d"} <br />
          {player2} f친r: {player1Piece === "yellow" ? "游댮 R칬d" : "游리 Gul"}
        </p>
      )}

      <button className={styles.startBtn} onClick={handleStartGame} disabled={submitting}>
        {submitting ? "Skapar..." : "B칬rja Spela"}
      </button>
    </div>
  );
};

export default GameSetup;
